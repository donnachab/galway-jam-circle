<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GJC Website - Feedback & Discussion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --primary-color: #371087; /* Correct Purple */
            --accent-color: #FFF7E0;  /* Lighter, Warmer Cream */
            --background-color: #f8f9fa; /* Lighter Gray */
            --text-dark: #1f2937;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background-color);
            color: var(--text-dark);
        }
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .bg-accent { background-color: var(--accent-color); }
        
        /* Custom heading style */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--primary-color);
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent-color);
        }
        .section-header h2 {
             margin-bottom: 0 !important;
        }

        /* Tab styling */
        .tab-button {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .vote-btn.voted-up {
            color: #10B981; /* Green-500 */
        }
        .vote-btn.voted-down {
            color: #EF4444; /* Red-500 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- HEADER -->
    <header class="bg-primary shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-white">Galway Jam Circle</h1>
            <p class="text-lg text-white/90">Website Feedback & Discussion Forum</p>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto space-y-12">
            
            <!-- Introduction Card -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="prose max-w-none">
                    <div class="section-header">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h2 class="m-0 p-0 border-none text-3xl font-bold">Welcome! Let's Build Our Website Together.</h2>
                    </div>
                    <p class="mt-6 text-lg text-gray-600">This page is a space for all members to review, discuss, and give feedback on our new official website. The goal is to create a central, easy-to-use hub for our community. Your input is crucial, so please read through the features below and share your thoughts in the form at the bottom!</p>
                </div>
            </div>

            <!-- Site Features Card -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="prose max-w-none">
                    <div class="section-header">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.707.707M12 21v-1" /></svg>
                        <h2 class="m-0 p-0 border-none text-3xl font-bold">What the Site Offers (The 'Why')</h2>
                    </div>
                    <p class="mt-6 text-lg text-gray-600">The main idea was to create a reliable, single source of truth for all GJC info, making it easier for current members and newcomers to know what's happening.</p>

                    <div class="mt-8 grid md:grid-cols-2 gap-8">
                        <!-- Feature 1 -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <span class="bg-accent text-primary p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></span>
                                Live & Automated Jam Schedule
                            </h3>
                            <p class="mt-2 text-gray-600">See the next five jams at a glance. The schedule is always up-to-date, removing the need to search through social media.</p>
                        </div>
                        <!-- Feature 2 -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <span class="bg-accent text-primary p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></span>
                                Easy Updates (Admin Mode)
                            </h3>
                            <p class="mt-2 text-gray-600">A simple, password-protected way for organisers to update the schedule, gallery, and events without any technical skills.</p>
                        </div>
                        <!-- Feature 3 -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                             <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <span class="bg-accent text-primary p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></span>
                                Discussion Point: Photo Strategy
                            </h3>
                            <p class="mt-2 text-gray-600">A proposed "quality over quantity" approach: use social media for lots of photos, but a curated, permission-based gallery on the site.</p>
                        </div>
                        <!-- Feature 4 -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                             <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <span class="bg-accent text-primary p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg></span>
                                Discussion Point: Payment Option
                            </h3>
                            <p class="mt-2 text-gray-600">A proposal to add a simple, no-monthly-fee online option for the voluntary â‚¬5 contribution using SumUp.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Form Card -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                 <div class="section-header">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                    <h2 class="m-0 p-0 border-none text-3xl font-bold">How You Can Help: Give Us Your Feedback!</h2>
                </div>
                <p class="mt-6 text-lg text-gray-600">This is where you come in. Please share any thoughts, ideas, or suggestions using the form below. Your comment will be posted publicly on this page for everyone to see and discuss.</p>

                <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-bold text-primary mt-0">Leave a Comment</h3>
                    <form id="feedback-form" class="mt-4">
                        <div class="mb-4">
                            <label for="feedback-topic" class="block text-sm font-bold text-gray-700 mb-2">1. What part of the site is your feedback about?</label>
                            <select id="feedback-topic" name="topic" class="w-full p-2 border border-gray-300 rounded-md">
                                <option>General Feedback</option>
                                <option>Website Section: Look and Feel</option>
                                <option>Website Section: Home Page</option>
                                <option>Website Section: Regular Jams</option>
                                <option>Website Section: Festivals & Events</option>
                                <option>Website Section: Our Format</option>
                                <option>Website Section: Gallery</option>
                                <option>Website Section: Contact & Footer</option>
                                <option>Website Feature: Admin Mode</option>
                                <option>Discussion Point: Photo Strategy</option>
                                <option>Discussion Point: Payment Feature</option>
                                <option>Other</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="feedback-comment" class="block text-sm font-bold text-gray-700 mb-2">2. What are your thoughts, ideas, or suggestions?</label>
                            <textarea id="feedback-comment" name="comment" rows="6" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Please be as specific as you can..." required></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="feedback-name" class="block text-sm font-bold text-gray-700 mb-2">3. Your Name (Optional)</label>
                            <input type="text" id="feedback-name" name="name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Let us know who you are!">
                        </div>

                        <div class="text-right">
                            <button type="submit" id="submit-feedback-btn" class="px-6 py-2 bg-primary text-white font-bold rounded-md hover:opacity-90 transition-opacity">Post Feedback</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Feedback Display Section -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="section-header">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V6a2 2 0 012-2h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H17z" /></svg>
                    <h2 class="m-0 p-0 border-none text-3xl font-bold">Community Feedback</h2>
                </div>
                
                <!-- Tab Navigation -->
                <div id="tab-container" class="border-b border-gray-200 mt-6 mb-4">
                    <nav class="-mb-px flex flex-wrap gap-x-4 gap-y-2" aria-label="Tabs">
                        <!-- Tabs will be inserted here by JS -->
                    </nav>
                </div>

                <!-- Tab Content Panels -->
                <div id="tab-content-container">
                     <!-- Content panels will be inserted here by JS -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white/80 py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <div class="space-x-4">
                <a href="#" id="admin-login-btn" class="text-sm text-stone-400 hover:text-white inline-block">Admin Login</a>
            </div>
            <p>&copy; 2025 Galway Jam Circle</p>
        </div>
    </footer>
    
    <div id="custom-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4"><p id="modal-message" class="text-lg mb-4"></p><input type="password" id="modal-input" class="w-full p-2 border rounded mb-4 hidden" placeholder="Enter password..."><div id="modal-buttons" class="flex justify-end space-x-4"></div></div></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, getDocs, doc, updateDoc, increment, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4SnqaOMQWmEFulkN8zZALZsqJLK7hOh0",
            authDomain: "galway-jam-circle-live.firebaseapp.com",
            projectId: "galway-jam-circle-live",
            storageBucket: "galway-jam-circle-live.appspot.com",
            messagingSenderId: "140452021164",
            appId: "1:140452021164:web:69703d13213d4ce49a3009"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const feedbackForm = document.getElementById('feedback-form');
        const tabContainer = document.getElementById('tab-container').querySelector('nav');
        const tabContentContainer = document.getElementById('tab-content-container');
        const topicDropdown = document.getElementById('feedback-topic');
        const allPossibleTopics = Array.from(topicDropdown.options).map(opt => opt.value);
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const ADMIN_PASSWORD = '4519';
        let feedbackUnsubscribe = null;
        let isInitialized = false; // <-- FIX: Global initialization flag

        // --- Post new feedback to Firestore ---
        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const comment = document.getElementById('feedback-comment').value;
            if (!comment.trim()) return;

            try {
                await addDoc(collection(db, "feedback"), {
                    topic: topicDropdown.value,
                    comment: comment,
                    name: document.getElementById('feedback-name').value || 'Anonymous',
                    timestamp: serverTimestamp(),
                    upvotes: 0,
                    downvotes: 0
                });
                feedbackForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                alert('Sorry, there was an error submitting your feedback. Please try again.');
            }
        });

        // --- Main listener for feedback and replies ---
        function listenForFeedback() {
             if (feedbackUnsubscribe) {
                feedbackUnsubscribe(); // Detach any old listener
            }
            const q = query(collection(db, "feedback"), orderBy("timestamp", "desc"));
            feedbackUnsubscribe = onSnapshot(q, (snapshot) => {
                renderAllPosts(snapshot);
            });
        }
        
        function renderAllPosts(snapshot) {
            tabContainer.innerHTML = '';
            tabContentContainer.innerHTML = '';

            if (snapshot.empty) {
                tabContentContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No feedback yet. Be the first to leave a comment!</p>';
                return;
            }

            const postsByTopic = new Map();
            snapshot.forEach(doc => {
                const feedback = doc.data();
                feedback.id = doc.id;
                if (!postsByTopic.has(feedback.topic)) postsByTopic.set(feedback.topic, []);
                postsByTopic.get(feedback.topic).push(feedback);
            });

            const activeTopics = allPossibleTopics.filter(topic => postsByTopic.has(topic));

            activeTopics.forEach((topic, index) => {
                const button = document.createElement('button');
                button.className = `tab-button whitespace-nowrap ${index === 0 ? 'active' : ''}`;
                button.textContent = topic;
                button.dataset.tab = topic;
                tabContainer.appendChild(button);

                const contentDiv = document.createElement('div');
                contentDiv.className = `tab-content space-y-6 ${index === 0 ? 'active' : ''}`;
                contentDiv.dataset.tabContent = topic;
                tabContentContainer.appendChild(contentDiv);

                const posts = postsByTopic.get(topic);
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    contentDiv.appendChild(postElement);
                    loadReplies(post.id, postElement.querySelector('.replies-container'));
                });
            });
        }
        
        // --- Tab Switching Logic ---
        tabContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                const targetTab = e.target.dataset.tab;
                tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                tabContentContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector(`[data-tab-content="${targetTab}"]`).classList.add('active');
            }
        });

        function createPostElement(feedback) {
            const element = document.createElement('div');
            element.className = 'p-5 bg-white border border-gray-200 rounded-lg shadow-sm';
            const date = feedback.timestamp ? feedback.timestamp.toDate().toLocaleString('en-IE') : 'Just now';
            const votedStatus = getVoteStatus(feedback.id);

            element.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="px-3 py-1 text-xs font-semibold text-primary bg-accent rounded-full">${feedback.topic}</span>
                    <span class="text-xs text-gray-500">${date}</span>
                </div>
                <p class="text-gray-700 whitespace-pre-wrap">${feedback.comment}</p>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-sm font-semibold text-gray-800">- ${feedback.name}</p>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-1">
                            <button data-post-id="${feedback.id}" data-vote-type="up" class="vote-btn p-1 rounded-full hover:bg-gray-200 ${votedStatus === 'up' ? 'voted-up' : 'text-gray-500'}">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333V17a1 1 0 001 1h6.364a1 1 0 00.942-.67l2.716-6A1 1 0 0016 9.333H12.5A1.5 1.5 0 0111 7.833V4.667a2 2 0 00-2-2h-1a2 2 0 00-2 2v5.666z"></path></svg>
                            </button>
                            <span class="text-sm font-semibold text-gray-700">${feedback.upvotes || 0}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button data-post-id="${feedback.id}" data-vote-type="down" class="vote-btn p-1 rounded-full hover:bg-gray-200 ${votedStatus === 'down' ? 'voted-down' : 'text-gray-500'}">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667V3a1 1 0 00-1-1h-6.364a1 1 0 00-.942.67l-2.716 6A1 1 0 004 10.667H7.5A1.5 1.5 0 019 12.167v3.166a2 2 0 002 2h1a2 2 0 002-2V9.667z"></path></svg>
                            </button>
                            <span class="text-sm font-semibold text-gray-700">${feedback.downvotes || 0}</span>
                        </div>
                        <button data-post-id="${feedback.id}" class="reply-btn text-sm text-primary font-semibold hover:underline">Reply</button>
                        <button data-post-id="${feedback.id}" class="delete-post-btn text-sm text-red-600 font-semibold hover:underline" style="display: none;">Delete</button>
                    </div>
                </div>
                <div class="replies-container ml-8 mt-4 space-y-3 border-l-2 border-gray-200 pl-4"></div>
                <div class="reply-form-container ml-8 mt-3"></div>
            `;
            return element;
        }
        
        function loadReplies(postId, container) {
            const repliesQuery = query(collection(db, `feedback/${postId}/replies`), orderBy("timestamp", "asc"));
            onSnapshot(repliesQuery, (snapshot) => {
                container.innerHTML = ''; // Clear old replies
                snapshot.forEach(doc => {
                    const replyData = doc.data();
                    replyData.id = doc.id;
                    replyData.postId = postId;
                    container.appendChild(createReplyElement(replyData));
                });
            });
        }

        function createReplyElement(reply) {
            const element = document.createElement('div');
            element.className = 'p-3 bg-gray-50 rounded-md border relative';
            const date = reply.timestamp ? reply.timestamp.toDate().toLocaleString('en-IE') : 'Just now';
            element.innerHTML = `
                <p class="text-gray-700 text-sm whitespace-pre-wrap">${reply.comment}</p>
                <div class="text-right text-xs text-gray-600 mt-2">
                    <strong>- ${reply.name}</strong> on ${date}
                </div>
                <button data-post-id="${reply.postId}" data-reply-id="${reply.id}" class="delete-reply-btn absolute top-1 right-1 text-red-500 hover:text-red-700" style="display: none;">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            `;
            return element;
        }

        // --- Handle Reply Button Clicks ---
        tabContentContainer.addEventListener('click', (e) => {
            const replyBtn = e.target.closest('.reply-btn');
            if (replyBtn) {
                const formContainer = replyBtn.closest('.p-5').querySelector('.reply-form-container');
                if (formContainer.innerHTML !== '') {
                    formContainer.innerHTML = '';
                    replyBtn.textContent = 'Reply';
                    return;
                }
                replyBtn.textContent = 'Cancel';
                formContainer.innerHTML = `
                    <form class="reply-form" data-post-id="${replyBtn.dataset.postId}">
                        <textarea name="reply-comment" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="Write a reply..." required></textarea>
                        <div class="flex justify-end items-center mt-2 space-x-2">
                             <input type="text" name="reply-name" class="w-1/2 p-2 border border-gray-300 rounded-md text-sm" placeholder="Your name (Optional)">
                             <button type="submit" class="px-4 py-1 bg-primary text-white text-sm font-bold rounded-md hover:opacity-90">Submit</button>
                        </div>
                    </form>
                `;
            }
        });

        // --- Handle Reply Form Submission ---
        tabContentContainer.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('reply-form')) {
                e.preventDefault();
                const form = e.target;
                const postId = form.dataset.postId;
                const comment = form.querySelector('[name="reply-comment"]').value;
                const name = form.querySelector('[name="reply-name"]').value || 'Anonymous';
                if (!comment.trim()) return;
                try {
                    await addDoc(collection(db, `feedback/${postId}/replies`), { comment, name, timestamp: serverTimestamp() });
                } catch (error) {
                    console.error("Error adding reply: ", error);
                    alert('Could not post reply.');
                }
            }
        });

        // --- Handle Voting ---
        tabContentContainer.addEventListener('click', (e) => {
            const voteBtn = e.target.closest('.vote-btn');
            if (voteBtn) {
                handleVote(voteBtn.dataset.postId, voteBtn.dataset.voteType);
            }
        });

        function getVoteStatus(postId) {
            const votes = JSON.parse(localStorage.getItem('gjc_votes') || '{}');
            return votes[postId]; // Will be 'up', 'down', or undefined
        }

        async function handleVote(postId, voteType) {
            const docRef = doc(db, "feedback", postId);
            const votes = JSON.parse(localStorage.getItem('gjc_votes') || '{}');
            const currentVote = votes[postId];
            let updates = {};

            if (currentVote === voteType) { // Un-voting
                updates[`${voteType}votes`] = increment(-1);
                delete votes[postId];
            } else { // New vote or changing vote
                updates[`${voteType}votes`] = increment(1);
                if (currentVote) { // Changing vote
                    updates[`${currentVote}votes`] = increment(-1);
                }
                votes[postId] = voteType;
            }
            
            localStorage.setItem('gjc_votes', JSON.stringify(votes));
            await updateDoc(docRef, updates);
        }

        // --- Admin Functionality ---
        adminLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (document.body.classList.contains('admin-mode')) {
                toggleAdmin(false);
            } else {
                showModal('Enter admin password:', 'prompt', (password) => {
                    if (password === ADMIN_PASSWORD) {
                        toggleAdmin(true);
                    } else {
                        showModal('Incorrect password.', 'alert');
                    }
                });
            }
        });

        function toggleAdmin(isAdmin) {
            document.body.classList.toggle('admin-mode', isAdmin);
            adminLoginBtn.textContent = isAdmin ? 'Admin Logout' : 'Admin Login';
            document.querySelectorAll('.delete-post-btn, .delete-reply-btn').forEach(btn => {
                btn.style.display = isAdmin ? 'inline-block' : 'none';
            });
        }

        tabContentContainer.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-post-btn')) {
                const postId = e.target.closest('.delete-post-btn').dataset.postId;
                if (confirm('Are you sure you want to delete this entire post and all its replies?')) {
                    // Delete all replies in the subcollection first
                    const repliesRef = collection(db, `feedback/${postId}/replies`);
                    const repliesSnapshot = await getDocs(repliesRef);
                    const batch = writeBatch(db);
                    repliesSnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    // Then delete the main post
                    await deleteDoc(doc(db, "feedback", postId));
                }
            }
            if (e.target.closest('.delete-reply-btn')) {
                const btn = e.target.closest('.delete-reply-btn');
                const postId = btn.dataset.postId;
                const replyId = btn.dataset.replyId;
                 if (confirm('Are you sure you want to delete this reply?')) {
                    await deleteDoc(doc(db, `feedback/${postId}/replies`, replyId));
                }
            }
        });

        // --- Modal ---
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalButtons = document.getElementById('modal-buttons');
        function showModal(message, type = 'alert', onConfirm = () => {}) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            modalInput.classList.add('hidden');
            if (type === 'alert') { const okButton = document.createElement('button'); okButton.textContent = 'OK'; okButton.className = 'px-4 py-2 bg-accent text-primary font-bold rounded-md'; okButton.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); onConfirm(); }; modalButtons.appendChild(okButton); } 
            else if (type === 'prompt') { modalInput.classList.remove('hidden'); modalInput.value = ''; modalInput.type = 'password'; const submitButton = document.createElement('button'); submitButton.textContent = 'Submit'; submitButton.className = 'px-4 py-2 bg-accent text-primary font-bold rounded-md'; submitButton.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); onConfirm(modalInput.value); }; const cancelButton = document.createElement('button'); cancelButton.textContent = 'Cancel'; cancelButton.className = 'px-4 py-2 bg-stone-600 text-white rounded-md'; cancelButton.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex');}; modalButtons.appendChild(cancelButton); modalButtons.appendChild(submitButton); }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if(type === 'prompt') modalInput.focus();
        }

        // --- Seed dummy posts if the collection is empty ---
        async function seedDummyPosts() {
            const feedbackCol = collection(db, "feedback");
            const snapshot = await getDocs(feedbackCol);
            if (snapshot.empty) {
                console.log('Feedback collection is empty. Seeding dummy posts.');
                await addDoc(feedbackCol, {
                    topic: "Website Section: Our Format",
                    comment: "The idea to add specific songbooks for each phase of the jam is brilliant. It would really help newcomers get up to speed and encourage more people to join in on songs they know.",
                    name: "Donnacha on behalf of Sarah",
                    timestamp: serverTimestamp(),
                    upvotes: 15, downvotes: 0
                });
                await addDoc(feedbackCol, {
                    topic: "Website Section: Look and Feel",
                    comment: "This is a great start! One small suggestion for the main homepage image: the white 'Welcome to the Galway Jam Circle' text can be a little difficult to read when it's over a bright part of the background photo (like the sky or water).\n\nA slightly stronger, darker overlay behind the text could really make it pop and improve readability on all screen sizes. What do you think?",
                    name: "Gemini",
                    timestamp: serverTimestamp(),
                    upvotes: 0, downvotes: 0
                });
            }
        }

        // --- Initialize the page ---
        async function init() {
            isInitialized = true; // Set flag to prevent re-initialization
            const snapshot = await getDocs(collection(db, "feedback"));
            if (snapshot.empty) {
                await seedDummyPosts();
            }
            listenForFeedback();
        }

        if (!isInitialized) {
            init();
        }

    </script>

</body>
</html>
